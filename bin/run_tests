#!/bin/bash -e

function summary() {
  if [[ ! -z "$GITHUB_STEP_SUMMARY" ]]; then
    echo "$*" >> $GITHUB_STEP_SUMMARY
  fi
}

function summaryrun() {
  local cmd="$*"
  ( $@ ) 
  rc="$?"
  summary "| $cmd | $rc |"
  return $rc
} 

function usage() {
  >&2 cat << EOF

$0 [step]

where [step] is one of:
  install_dependencies
  code_checks
  schema_tests
  trace_tests
  registrar_tests
  all_tests
EOF
  false
}

#
# main
#

testname="$1"

summary "# $0"
summary "## $testname"
summary "| Test | Exit status |"

case "$testname" in
  install_dependencies)
    summaryrun bin/setup_base
    summaryrun bin/clone_model
    sudo ln -fs $PWD/bin/udmi /usr/local/bin/
    ;;
  code_checks)
    summaryrun bin/gencode check
    summaryrun pubber/bin/build check
    summaryrun validator/bin/build check
    summaryrun bin/test_pylint
    summaryrun bin/test_locate
    ;;
  schema_tests)
    summaryrun bin/test_schema
    ;;
  trace_tests)
    summaryrun bin/test_trace simple
    ;;
  registrar_tests)
    summaryrun bin/test_registrar
    summaryrun bin/test_sites
    ;;
  all_tests)
    bin/run_tests code_checks
    bin/run_tests schema_tests
    bin/run_tests trace_tests
    bin/run_tests registrar_tests
    ;;
  *)
    usage
    ;;
esac
